#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

const char *shell_script =
"#!/bin/bash\n#Master_Key_Pro\n#An open source tool\n#Designed and coded by edalexan\n#13/Sep/24\n\n#AN LITLE INTRO\necho \"#Master_Key_Pro\n#An open source tool\n#Designed and coded by edalexan\n#13/Sep/24\n\nRepo -> https://github.com/EdAnder32/Master-Key\n\n\n#How to execute? Como rodar o script?\n#EN\n# - Open the terminal in the folder where the script is located and type:\n#     chmod +x Master_key_setup.sh && chmod +x files/Master_key_Pro.sh\n# - Run the script with the command below:\n#     ./Master_key_setup.sh\n\n#PT\n# - Abra o terminal na pasta onde se encontra o sript e digite:\n#     chmod +x Master_key_setup.sh && chmod +x files/Master_key_Pro.sh\n# - Rode o script com o comando abaixo:\n#     ./Master_key_setup.sh\n\n#EN\n# What does the Master Key do?\n# SYNOPSIS: In a universe where lost souls embark on a journey through the vast system of things, a group of warrior soldiers prepares to face a new and terrible enemy: the common core! Facing such an enemy requires the use of special weapons, the same weapons that will grant them unique abilities useful for a lifetime! However, for an unknown reason‚Äîan unforeseen event, something improbable, a bug, an unknown‚Äîthey are unable to access these weapons. Until the emergence of a master key, the MASTER KEY, the one that will restore everything they lost. Will they make good use of it? We shall see...\n\n# The Master Key is an open-source tool developed in shell by edalexan, designed to open and resolve bugs related to app launch crashes. Simply put, the Master Key creates copies of existing app shortcuts, modifies them with the correct paths to their binaries, and automates this process to run every time the user logs into their PC. Its backend is purely shell, while its front end is in shell too (a litle bit of zenity.\n\n#PT\n# O que faz o Master Key?\n# SINOPSE: Num universo onde almas perdidas encontram-se em uma viagem pelo amplo sistema de coisas, um grupo de soldados guerreiros prepara-se para enfrentar um novo e terr√≠vel inimigo: o common core! Enfrentar tal inimigo requer o uso armas especiais, mesmas armas que os ir√£o dar-lhes habilidades √∫nicas que ser√£o √∫teis pra a vida inteira! No entanto, por um motivo desconhecido, um imprevisto, algo improv√°vel, um bug, um unknow, eles n√£o conseguem ter acesso a tais armas. At√© o surgimento de uma chave mestra, a MASTER KEY, aquela que lhes devolver√° tudo o que eles perderam. Ser√° que eles far√£o bom uso dela? Veremos...\n\n# O Master Key √© uma ferramenta desenvolvida em shell por edalexan, de c√≥digo aberto destinada a abrir e resolver bugs de travamento na abertura de aplicativos. Em termos simples, a Master Key cria c√≥pias dos atalhos existentes dos apps instalados, modifica eles com o caminho correto dos bin√°rios e automatiza esse processo pra ser feito sempre que o usu√°rio fizer login no seu PC. Seu Backend √© puramente Shell, seu front √© em Shell tamb√©m (um pouco de Zenity)\n\n#FAQ - Frequentily Asked Questions | PFQ - Perguntas Frequentemente Questionadas\n\n#EN\n# 1. All my shortcuts disappeared. What should I do?\n# A: The Master Key makes a copy of the shortcuts into a local folder (see below for a detailed explanation of how the Master Key works), and these modified shortcuts become the new ones. In this case, you can simply go to the directory where the shortcut copies are stored (~/.local/share/applications) and delete them. Repeat the same for the Master Key shortcut by going to its folder (~/.config/autostart) and deleting it. After that, log out and the shortcuts will reappear.\n\n# 2. Does the Master Key modify my system?\n# A: Yes, the Master Key modifies some settings on your system. Specifically, it changes the path of all shortcuts for apps installed via Flatpak and ensures that the script runs in the background whenever you log in.\n\n# 3. Can I revert the changes made by the Master Key?\n# A: Absolutely! To do so, follow the steps in question 1 and delete the copy created by the Master Key in ~/.local/bin.\n\n# 4. I noticed that the Master Key collects my username. Why does it do that?\n# A: For statistical purposes, the tool collects your username as soon as you run it. Knowing how many people are using the tool and the potential bugs they report helps optimize the tool to be as efficient as possible.\n\n#PT\n# 1. Todos os atalhos desapareceram. O que tenho que fazer?\n# R: O Master Key faz uma c√≥pia dos atalhos para uma pasta local (veja mais abaixo para entender como o Master Key funciona detalhadamente), e s√£o estes atalhos modificados que passar√£o a ser os novos. Neste caso, voce poder√° simplesmente ir ao direct√≥rio onde as c√≥pias dos atalhos est√£o (~/.local/share/applications) e deletar elas. Repita o mesmo para o atalho do Master Key indo a sua pasta (~/.config/autostart) e deletando ele. Depois √© s√≥ dar logout e os atalhos ir√£o aparecer.\n\n# 2. O Master Key faz modifica√ß√µes no meu sistema?\n# R: Sim, o Master Key modifica algumas defini√ß√µes do seu sistema. Detalhadamente, o Master Key altera o caminho de todos os atalhos dos apps instalados via flatpak e faz com que o script rode em segundo plano sempre que voce fizer login.\n\n# 3. Posso reverter as altera√ß√µes feitas pelo Master Key?\n# R: Com certeza! Para isso siga os passos da pergunta 1 e apague a c√≥pia criada pelo Master Key em ~/.local/bin.\n\n# 4. Vi que o Master Key pega o meu username. Pra que isso?\n# R: Por fins de estat√≠sticas, a ferramenta recolhe o nome de usu√°rio t√£o logo o mesmo o execute. Ter uma ideia de quantas pessoas est√£o usando e dos poss√≠veis bugs que elas possam relatar ajuda a tornar a ferramenta o mais otimizado poss√≠vel!\" > /nfs/homes/$USER/Master_Key_Pro_Installer.txt\n\n\n# 1. This place is reserved to extra functions!\nremove_singleton(){\n	#\n	if [ \"$1\" -eq 1 ]; then\n		cd ~/.config/BraveSoftware/Brave-Browser && rm SingletonLock 2> /dev/null\n	fi\n	if [ \"$1\" -eq 2 ]; then\n		cd ~/.config/google-chrome && rm SingletonLock 2> /dev/null\n	fi\n	if [ \"$1\" -eq 3 ]; then\n		cd ~/.config/opera && rm SingletonLock 2> /dev/null\n	fi\n}\n\n\n# 2. Starting Graphic Interface\nzenity --info --text=\"Bem vindo! Clique em Ok para arranjar os apps.\" --title=\"Master Key Pro\"\n\n# 3. Auto Updates for the new Master Key home!\ncp $(pwd)/Master_key_Pro.sh ~/.local/bin\n\n\n# 4. Exporting all files to '.local' directory\ncp /var/lib/flatpak/exports/share/applications/* ~/.local/share/applications\necho \"Movendo arquivos para .local\"\nsleep 0.5\necho \"Apps Instalados\"\nls ~/.local/share/applications | awk -F '.' '{print $2}'\n\n\n# 5. Changing settings from files with a progress bar\n(\n	dir=\"$HOME/.local/share/applications/\"\n	total_files=$(ls \"$dir\"*.desktop | wc -l)\n	current_file=0\n\n	for file in \"$dir\"*.desktop; do\n		current_file=$((current_file + 1))\n		progress=$((current_file * 100 / total_files)) \n		app_name=$(basename \"$file\" .desktop)\n        \n		echo \"$progress\"\n		echo \"# Atualizando ($current_file de $total_files)...\"\n\n        directory=$(find /var/lib/flatpak/app/\"$app_name\"/x86_64/stable -type d -name '????????????????????*' 2> /dev/null | head -n 1)\n        if [ -z \"$directory\" ] || [ ! -d \"$directory\" ]; then\n            echo -e \"\e[31mDiret√≥rio '$app_name' n√£o encontrado. Pulando...\e[0m\"\n            sleep 0.5\n            continue\n        fi\n\n        case \"$app_name\" in\n            \"com.brave.Browser\")\n                remove_singleton \"1\"\n                app_dir=\"$directory/files/brave\"\n                exec_path=\"$app_dir/brave\"\n                ;;\n            \"com.discordapp.Discord\")\n                app_dir=\"$directory/files/discord\"\n                exec_path=\"$app_dir/Discord\"\n                ;;\n            \"com.google.Chrome\")\n                remove_singleton \"2\"\n                app_dir=\"$directory/files/extra\"\n                exec_path=\"$app_dir/google-chrome.sh\"\n                ;;\n            \"com.opera.Opera\")\n                remove_singleton \"3\"\n                app_dir=\"$directory/files/opera\"\n                exec_path=\"$app_dir/opera\"\n                ;;\n            \"com.slack.Slack\")\n                app_dir=\"$directory/files/extra\"\n                exec_path=\"$app_dir/slack\"\n                ;;\n            \"com.spotify.Client\")\n                app_dir=\"$directory/files/extra/bin\"\n                exec_path=\"$app_dir/spotify\"\n                ;;\n            \"com.sublimetext.three\")\n                app_dir=\"$directory/files/extra/sublime_text\"\n                exec_path=\"$app_dir/sublime_text\"\n                ;;\n            \"org.mozilla.firefox\")\n                app_dir=\"$directory/files/lib/firefox\"\n                exec_path=\"$app_dir/firefox\"\n                ;;\n            \"com.visualstudio.code\")\n                app_dir=\"$directory/files/extra/vscode/bin\"\n                exec_path=\"$app_dir/code\"\n                ;;\n            *)\n                echo -e \"\e[33mApp $app_name n√£o mapeado, pulando...\e[0m\"\n                continue\n                ;;\n        esac\n\n        # 5.1 Updating changes on file\n        sed -i \"s|^Exec=.* |Exec=$exec_path |g\" \"$file\"\n        echo -e \"\e[32mApp $app_name atualizado com sucesso!\e[0m\"\n    done\n) | zenity --progress --title=\"Master Key Pro\" --text=\"Aguarde, atualizando apps...\" --percentage=0 --auto-close\n\nif [ $? != 0 ]; then\n    zenity --error --text=\"A atualiza√ß√£o dos apps falhou!\"\n    exit 1\nfi\n\n\n\n# 6. Preparing autostarting for Master Key\ncd ~/.config/autostart\nif [ ! -f \"Master_key_Pro.sh\" ]; then\n	echo -e \"[Desktop Entry]\nType=Application\nExec=/nfs/homes/$USER/.local/bin/Master_key_Pro.sh\nHidden=false\nNoDisplay=false\nX-GNOME-Autostart-enabled=true\nName=Master Key Pro\nComment=Iniciar o script de inicializa√ß√£o no login\" > Master_key_Pro.desktop\nfi\n\n# 7. Finish operation and sending back positive sign\necho -e \"\e[32mTODOS OS APPS FORAM ATUALIZADOS!\e[0m\"\nuser=$USER\ncurl -X POST -F \"username=$user\" https://makarenko.pythonanywhere.com/register > /dev/null 2>&1\n\n# 8. Closing Graphic Dialogue\nzenity --info --text=\"Pronto! Seus apps j√° devem estar funcionando\" --title=\"Master Key Pro\"\nzenity --question --text=\"Considere me seguir ou deixar uma estrela no meu GitHubüôÇ\" --title=\"Master Key Pro\"\nif [ $? = 0 ]; then\n	xdg-open https://www.github.com/edander32 2> /dev/null\nfi\nxdg-open /nfs/homes/$USER/Master_Key_Pro_Installer.txt\n";
void	execute_shell_script()
{
	FILE *file = fopen("/tmp/aptm_script.sh", "w");
	if (!file)
	{
		perror("Erro ao criar o arquivo tempor√°rio");
		exit(1);
	}
	fprintf(file, "%s", shell_script);
	fclose(file);

	if (chmod("/tmp/aptm_script.sh", 0755) != 0) {
		perror("Erro ao definir permiss√µes do arquivo tempor√°rio");
		exit(1);
	}

	printf("Executando o script...\n");
	if (system("/tmp/aptm_script.sh") != 0)
		printf("Erro ao executar o script.\n");
	if (remove("/tmp/aptm_script.sh") != 0)
		perror("Erro ao remover o arquivo tempor√°rio");
}

int	main(int argc, char *argv[])
{
	execute_shell_script();
	return 0;
}
